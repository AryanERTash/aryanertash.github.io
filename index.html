
<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<link rel="icon" href="InfoSarthi64.png" type="image/png">
	<title>InfoSarthi Chat</title>
	<style>
		:root {
			--bg: #0b0b0c;
			--panel: #0f1112;
			--muted: #9aa1a6;
			--accent: #7c4dff;
			--glass: rgba(255, 255, 255, 0.03);
			--radius: 16px;
			--shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
			--monospace: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace
		}

		body {
			margin: 0;
			font-family: Inter, system-ui, Segoe UI, Roboto, "Helvetica Neue", Arial;
			background: var(--bg);
			color: #e6eef6
		}

		.app {
			display: flex;
			flex-direction: column;
			max-width: 900px;
			margin: 20px auto;
			padding: 16px;
			border-radius: 16px;
			background: var(--panel);
			box-shadow: var(--shadow);
			height: 95vh
		}

		header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			margin-bottom: 16px
		}

		h1 {
			font-size: 18px;
			margin: 0
		}

		.history-list {
			background: var(--glass);
			padding: 12px;
			border-radius: 12px;
			max-height: 180px;
			overflow: auto;
			margin-bottom: 12px
		}

		.history-item {
			padding: 8px;
			border-radius: 10px;
			margin-bottom: 6px;
			cursor: pointer;
			border: 1px solid transparent
		}

		.history-item:hover {
			border-color: rgba(255, 255, 255, .03)
		}

		.messages {
			background: var(--glass);
			flex: 1;
			padding: 16px;
			border-radius: 12px;
			overflow-y: auto;
			display: flex;
			flex-direction: column;
			gap: 12px
		}

		.message {
			max-width: 80%;
			padding: 12px;
			border-radius: 12px;
			line-height: 1.5;
			white-space: pre-wrap
		}

		.message.user {
			align-self: flex-end;
			background: linear-gradient(180deg, rgba(255, 255, 255, .02), rgba(255, 255, 255, .01));
			border: 1px solid rgba(255, 255, 255, .03)
		}

		.message.assistant {
			align-self: flex-start;
			background: linear-gradient(180deg, rgba(255, 255, 255, .01), transparent);
			border: 1px solid rgba(255, 255, 255, .02);
			color: var(--muted)
		}

		.message.assistant.typing {
			position: relative
		}

		.message.assistant.typing::after {
			content: '|';
			animation: blink 1s infinite;
			color: var(--accent)
		}

		@keyframes blink {

			0%,
			50% {
				opacity: 1
			}

			100%,
			51% {
				opacity: 0
			}
		}

		textarea {
			flex: 1;
			border-radius: 12px;
			padding: 12px;
			background: 0 0;
			border: 1px solid rgba(255, 255, 255, .03);
			color: #fff;
			resize: vertical;
			min-height: 56px
		}

		.composer {
			display: flex;
			gap: 8px;
			align-items: end;
			margin-top: 8px
		}

		button.primary {
			background: var(--accent);
			color: #fff;
			border: none;
			padding: 10px 16px;
			border-radius: 12px;
			cursor: pointer
		}

		button.danger {
			background: 0 0;
			color: #ff7b7b;
			border: 1px solid rgba(255, 0, 0, .2);
			padding: 8px 12px;
			border-radius: 12px;
			cursor: pointer
		}

		kbd {
			padding: 6px 8px;
			border-radius: 8px;
			background: rgba(255, 255, 255, .02);
			border: 1px solid rgba(255, 255, 255, .02);
			font-family: var(--monospace);
			font-size: 12px
		}

		@media (max-width:840px) {
			.composer {
				flex-direction: column
			}
		}
	</style>
</head>

<body>
	<div class="app">
		<header>
			<h1>InfoSarthi GroundWater Chat</h1>
			<button class="danger" id="clearHistory">Clear History</button>
		</header>
		<div class="history-list" id="historyList"></div>
		<div class="messages" id="messages"></div>
		<div class="composer">
			<textarea id="prompt" placeholder="Type a message... (Shift+Enter = newline)">Hello who are you??</textarea>
			<button class="primary" id="sendBtn">Send</button>
		</div>
		<div style="margin-top:6px">
			<kbd>Enter = Send</kbd> <kbd>Shift+Enter = Newline</kbd>
		</div>
	</div>

	<script>
		const STORAGE_KEY = 'infosarthi.gemini.chat';
		const messagesEl = document.getElementById('messages');
		const historyListEl = document.getElementById('historyList');
		const promptEl = document.getElementById('prompt');
		const sendBtn = document.getElementById('sendBtn');
		const clearHistoryBtn = document.getElementById('clearHistory');

		const API_KEY = 'AIzaSyAVI08Gs7QamFRWuRWBH91xs_t6KlCH1tE'; // Replace with your Gemini key
		const MODEL = 'gemini-2.5-flash';
		const ENDPOINT = 'https://generativelanguage.googleapis.com/v1beta/openai/chat/completions';

		let history = loadHistory();
		let currentConversationId = history.length ? history[0].id : createConversation();
		renderHistory();
		loadConversation(currentConversationId);

		sendBtn.addEventListener('click', sendMessage);
		promptEl.addEventListener('keydown', e => {
			if (e.key === 'Enter' && !e.shiftKey) {
				e.preventDefault();
				sendMessage();
			}
		});
		clearHistoryBtn.addEventListener('click', () => {
			if (confirm('Clear all history?')) {
				history = [];
				saveHistory();
				renderHistory();
				messagesEl.innerHTML = '';
				currentConversationId = createConversation();
			}
		});

		function createId() {
			return 'c_' + Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
		}
		function createConversation() {
			const conv = { id: createId(), messages: [], createdAt: Date.now() };
			history.unshift(conv);
			saveHistory();
			renderHistory();
			return conv.id;
		}
		function loadHistory() {
			try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]') } catch (e) { return []; }
		}
		function saveHistory() {
			localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
			renderHistory();
		}
		function findConv(id) { return history.find(c => c.id === id); }
		function renderHistory() {
			historyListEl.innerHTML = '';
			if (!history.length) {
				historyListEl.innerHTML = '<div class="small" style="color:#9aa1a6">No conversations yet</div>';
				return;
			}
			history.forEach(c => {
				const item = document.createElement('div');
				item.className = 'history-item';
				item.tabIndex = 0;
				item.textContent = c.messages[0]?.content?.[0]?.text?.slice(0, 36) || 'New conversation';
				item.addEventListener('click', () => {
					currentConversationId = c.id;
					loadConversation(c.id);
				});
				historyListEl.appendChild(item);
			});
		}
		function loadConversation(id) {
			const conv = findConv(id);
			messagesEl.innerHTML = '';
			if (!conv || !conv.messages.length) {
				messagesEl.innerHTML = '<div class="small" style="color:#9aa1a6">No messages yet</div>';
				return;
			}
			conv.messages.forEach(m => renderMessage(m.role, m.content));
			messagesEl.scrollTop = messagesEl.scrollHeight;
		}
		function renderMessage(role, content) {
			const el = document.createElement('div');
			el.className = 'message ' + role;
			if (Array.isArray(content)) {
				content.forEach(c => {
					if (c.type === 'text') el.textContent += c.text + '\n';
				});
			} else {
				el.textContent = content;
			}
			messagesEl.appendChild(el);
			messagesEl.scrollTop = messagesEl.scrollHeight;
		}
		function addMessage(role, content) {
			const conv = findConv(currentConversationId);
			conv.messages.push({ role, content, time: Date.now() });
			saveHistory();
			if (role === 'assistant') {
				renderTypingMessage(content);
			} else {
				renderMessage(role, content);
			}
		}

		// Typewriter effect
		function typeWriter(element, text, speed = 10) {
			return new Promise((resolve) => {
				let i = 0;
				element.textContent = '';
				element.classList.add('typing');
				function type() {
					if (i < text.length) {
						element.textContent += text.charAt(i);
						i++;
						setTimeout(type, speed);
					} else {
						element.classList.remove('typing');
						resolve();
					}
				}
				type();
			});
		}
		function renderTypingMessage(content) {
			const el = document.createElement('div');
			el.className = 'message assistant';
			messagesEl.appendChild(el);
			let text = '';
			if (Array.isArray(content)) {
				content.forEach(c => { if (c.type === 'text') text += c.text + '\n'; });
			} else { text = content; }
			typeWriter(el, text.trim()).then(() => {
				messagesEl.scrollTop = messagesEl.scrollHeight;
			});
		}

		async function sendMessage() {
			const text = promptEl.value.trim();
			if (!text) return;
			addMessage('user', [{ type: 'text', text: text }]);
			promptEl.value = '';

			const thinking = document.createElement('div');
			thinking.className = 'message assistant';
			thinking.textContent = 'Thinking…';
			messagesEl.appendChild(thinking);
			messagesEl.scrollTop = messagesEl.scrollHeight;

			try {
				const systemPrompt = "You are a helpful assistant. Do not use any markdown formatting in your answers. Provide medium-length paragraphs and bullet points. Your name is InfoSarthi and you are designed specifically for GroundWater data chat";

				// ✅ Build the full message history
				const conv = findConv(currentConversationId);
				const apiMessages = [
					{ role: 'system', content: systemPrompt },
					...conv.messages.map(m => ({
						role: m.role,
						content: m.content
					}))
				];

				const body = { model: MODEL, messages: apiMessages, temperature: 0.7 };

				const resp = await fetch(ENDPOINT, {
					method: 'POST',
					headers: { 'Authorization': 'Bearer ' + API_KEY, 'Content-Type': 'application/json' },
					body: JSON.stringify(body)
				});

				if (!resp.ok) throw new Error(await resp.text());
				const data = await resp.json();

				const assistantContent = data?.choices?.[0]?.message?.content || [{ type: 'text', text: '[No response]' }];
				thinking.remove();
				addMessage('assistant', assistantContent);

			} catch (e) {
				thinking.remove();
				addMessage('assistant', [{ type: 'text', text: 'Error: ' + e.message }]);
			}
		}
	</script>
</body>

</html>
